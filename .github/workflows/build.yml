name: Build and SonarCloud Analysis

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest  # Utilisation d'un environnement Windows

    steps:
      # Étape 1 : Checkout du code
      - name: Checkout code
        uses: actions/checkout@v3

      # Étape 2 : Cache SonarCloud packages
      - name: Cache SonarCloud packages
        uses: actions/cache@v3
        with:
          path: C:\Users\runneradmin\.sonar\cache
          key: ${{ runner.os }}-sonar

      # Étape 3 : Téléchargement de build-wrapper pour Windows
      - name: Download build-wrapper
        run: |
          Invoke-WebRequest -Uri "https://sonarcloud.io/static/cpp/build-wrapper-win-x86.zip" -OutFile "build-wrapper-win-x86.zip"
          Expand-Archive build-wrapper-win-x86.zip -DestinationPath "C:\build-wrapper"
        shell: pwsh

      # Étape 3.1 : Vérification de l'existence des fichiers build-wrapper
      - name: Verify build-wrapper files
        run: |
          dir C:\build-wrapper
        shell: pwsh

      # Étape 4 : Construction du projet (exemple pour un projet C/C++)
      - name: Build the project
        run: |
          C:\build-wrapper\build-wrapper-win-x86\build-wrapper-win-x86-64.exe --out-dir bw-output cmake --build .  # Adapte en fonction de ton projet
        shell: pwsh

      # Étape 5 : Exécution de l'analyse SonarCloud
      - name: Run SonarCloud analysis
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          args: >
            -Dsonar.organization=heyyymen
            -Dsonar.projectKey=Heyyymen_Projet_c
            -Dsonar.sources=.
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.cfamily.build-wrapper-output=bw-output
            -Dsonar.cfamily.compile-commands=compile_commands.json
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}  # Utilisation sécurisée du token à partir des secrets GitHub
